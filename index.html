<!DOCTYPE html>
<html class="no-js">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <script src="jquery.min.js"></script>
    <title>NODA Case API Example</title>
</head>
<body>
<h2>Feature</h2>
<div id="case-list-feature"></div>

<h2>Application</h2>
<div id="case-list-application"></div>

<h2>Investigative</h2>
<div id="case-list-investigative"></div>


<script>
var renderCaselist = function(elementSelector, posts) {
    var $elem = $(elementSelector);
    var $list = $("<ul/>").attr("class","noda-case-list");
    $elem.append($list);

    posts.forEach(function(d) {
        $listItem = "<li>" +
        //"<img src='" + d.image + "' class='image'>" + 
        "<a href='" + d.link + "'>" +
        "<h3>" + d.title.rendered + "</h3>" + 
        "</a>" +
        "<dl>" +
        "<dt>Publisher:</dt>" +
        "<dd class='publisher'>"+d.publishers.map(function(_d) { return _d.title.rendered; }).join(",")+"</dd>" +
        "<dt>Status:</dt>" +
        "<dd class='status'>"+d.case_status+"</dd>" +
        "<dt>Category:</dt>" +
        "<dd>" + d.case_category + "</dd>" +
        "</dl>" +
        "<div class='excerpt'>" + d.excerpt.rendered + "</div>"
        "</li>";
        $elem.append($listItem); 
    })
}

// Returns a query object used to get filterd data from database 
// Status can be submission|nominee|winner 
// Category can be feature|application|investigative|challenge 
function getQuery(status, category, case_competition) {
    var query = {
        posts_per_page: 999,
        meta_query: { 
            relation: 'AND',
            0: {
                key: 'case_status',
                value: status,
                compare: '='
            },
            1: {
                key: 'case_competition',
                value: case_competition,
                compare: '='

            }
        }
    };
    if (category) {
        query.meta_query[2] = {
            key: 'case_category',
            value: category,
            compare: '='
        }
    }
    return query;
}


var categories = ["feature", "application", "investigative", "other"];
var case_competition = "NODA Awards 2017";
var status = "submission";
categories.forEach(function(category) {
    jQuery.getJSON('http://nodabase.net/cases/?json', getQuery(status, category, case_competition), function(data, status){
        renderCaselist("#case-list-" + category, data.posts)
    })    
})

</script>
</body>
</html>